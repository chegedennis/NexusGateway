<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Payment</title>
    
<style>
    /* BASIC RESET & OFFLINE STYLES */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .status-card {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 350px;
        text-align: center;
    }

    /* PULSE ANIMATION */
    .pulse-container {
        position: relative;
        width: 60px;
        height: 60px;
        margin: 0 auto 20px auto;
    }
    .pulse-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 3px solid #4CAF50;
        opacity: 0;
        animation: pulse 2s infinite;
    }
    .pulse-ring:nth-child(2) { animation-delay: 0.5s; }
    
    @keyframes pulse {
        0% { transform: scale(0.5); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: scale(1.5); opacity: 0; }
    }

    /* TYPOGRAPHY */
    h2 { font-size: 1.5rem; margin-bottom: 10px; color: #333; }
    p { color: #666; font-size: 0.9rem; line-height: 1.5; margin-bottom: 15px; }
    .phone-highlight { background: #eee; padding: 2px 6px; border-radius: 4px; font-weight: bold; color: #333; }
    .icon { font-size: 30px; line-height: 60px; }
    
    /* FAILED STATE */
    .state-failed .pulse-ring { border-color: red; animation: none; }
    .btn-retry {
        display: inline-block;
        background: #333;
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 20px;
        margin-top: 15px;
    }
</style>
</head>
<body>

    <div class="status-card" id="mainCard">
        <div class="pulse-container" id="visualArea">
            <div class="pulse-ring"></div>
            <div class="pulse-ring"></div>
            <div class="pulse-ring"></div>
            <div class="phone-icon" id="icon">ðŸ“±</div>
        </div>

        <h2 id="statusTitle">Check your phone</h2>
        <p id="statusDesc">
            We sent a request to <span class="phone-highlight">{{ phone }}</span>.<br>
            Enter your M-Pesa PIN to connect.
        </p>

        <div id="actionArea" style="display: none;">
            <a href="/" class="btn btn-retry">Try Again</a>
        </div>
    </div>

    <script>
        const phone = "{{ phone }}";
        const card = document.getElementById('mainCard');
        const visualArea = document.getElementById('visualArea');
        const icon = document.getElementById('icon');
        const title = document.getElementById('statusTitle');
        const desc = document.getElementById('statusDesc');
        const actionArea = document.getElementById('actionArea');

        function checkStatus() {
            fetch(`/check_status/${phone}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'COMPLETED') {
                        // SUCCESS
                        window.location.href = "/success/";
                        
                    } else if (data.status === 'FAILED') {
                        // FAILURE ANIMATION
                        
                        // 1. Change visual state
                        card.classList.add('state-failed');
                        icon.innerText = "âœ•"; // Switch phone to X
                        
                        // 2. Change Text
                        title.innerText = "Payment Cancelled";
                        desc.innerHTML = "You cancelled the request on your phone.<br>No money was deducted.";
                        
                        // 3. Show Button
                        actionArea.style.display = "block";
                        
                    } else {
                        // KEEP POLLING
                        setTimeout(checkStatus, 2000);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Start the loop
        checkStatus();
    </script>

</body>
</html>